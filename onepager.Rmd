---
title: "Ihr persönliches Ergebnis"
output:
  html_document:
    self_contained: true
    toc: false
    theme: readable
params:
  ergebnis: !r data.frame()
  photo_url: ""
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, fig.align = "center", fig.width = 8, fig.height = 5)

# Eingabedaten (genau 1 Zeile erwartet)
df <- params$ergebnis
stopifnot(nrow(df) >= 1)

# Werte entpacken
teilnehmer_id <- as.character(df$ID[1])
uf <- as.numeric(df$Unternehmerfaehigkeit[1])
lm <- as.numeric(df$Leistungsmotivation[1])

roles_raw <- c(
  "Verkaeufer","Finance_Coordinator","Captain","Pioneer",
  "Netzwerker","Operator","Productlead","Business_Developer"
)
role_vals <- as.numeric(df[1, roles_raw])
names(role_vals) <- c("Verkäufer","Finance\nCoordinator","Captain","Pioneer",
                      "Netzwerker","Operator","Product Lead","Business\nDeveloper")

dom <- as.character(df$Dominante_Rolle[1])

# ---------- kleine Hilfen ----------
clamp <- function(x, lo, hi) pmax(lo, pmin(hi, x))

# Radar/Spinnen-Plot in Base R (ohne Zusatzpakete)
spider_plot <- function(vals, labels, maxv = 100,
                        grid_steps = 5, title = "", col_fill = "#3B82F6") {
  n <- length(vals)
  ang <- seq(0, 2*pi, length.out = n + 1)[1:n]
  r <- clamp(vals / maxv, 0, 1)

  x <- r * cos(ang)
  y <- r * sin(ang)

  plot(0, 0, type = "n", xlim = c(-1.25, 1.25), ylim = c(-1.25, 1.25),
       axes = FALSE, xlab = "", ylab = "", asp = 1, main = title, cex.main = 1.15)

  gr <- seq(0, 1, length.out = grid_steps + 1)[-1]
  for (g in gr) symbols(0, 0, circles = g, inches = FALSE, add = TRUE, fg = "#e5e7eb")
  for (i in seq_len(n)) segments(0, 0, cos(ang[i]), sin(ang[i]), col = "#e5e7eb")

  polygon(c(x, x[1]), c(y, y[1]),
          border = "#1f2937", col = adjustcolor(col_fill, alpha.f = 0.25), lwd = 2)
  points(x, y, pch = 16, col = col_fill)

  lab_r <- 1.12
  text(lab_r * cos(ang), lab_r * sin(ang), labels, cex = 0.9)
}

# Einfache regelbasierte Beschreibung
describe_profile <- function(dom, uf, lm) {
  dom_text <- switch(dom,
    "Verkaeufer"          = "kundenorientiert, überzeugungsstark und vertriebsaffin",
    "Finance_Coordinator" = "strukturiert, zahlenstark und prozesssicher",
    "Captain"             = "führungsstark, entscheidungsfreudig und klar in der Linie",
    "Pioneer"             = "innovationsgetrieben, experimentierfreudig und zukunftsorientiert",
    "Netzwerker"          = "verbindend, kommunikativ und stark im Beziehungsaufbau",
    "Operator"            = "operativ exzellent, verlässlich und qualitätsgetrieben",
    "Productlead"         = "produktfokussiert, analytisch und nutzerzentriert",
    "Business_Developer"  = "wachstumsorientiert, strategisch und marktbeobachtend",
    "ausgewogen"
  )

  uf_text <- if (uf >= 4.0) {
    "Ihre unternehmerische Selbstwirksamkeit ist **sehr hoch** – Sie gehen Themen mutig und eigenverantwortlich an."
  } else if (uf >= 3.0) {
    "Ihre unternehmerische Selbstwirksamkeit ist **solide** – Sie agieren zuverlässig und pragmatisch."
  } else {
    "Ihre unternehmerische Selbstwirksamkeit ist aktuell **zurückhaltend** – Erfahrungsaufbau und Lernkurve zahlen sich aus."
  }

  lm_text <- if (lm >= 4.0) {
    "Ihre Leistungsmotivation ist **sehr hoch** – Sie suchen aktiv Herausforderung und klare Ziele."
  } else if (lm >= 3.0) {
    "Ihre Leistungsmotivation ist **stabil** – Sie arbeiten zielorientiert und kontinuierlich."
  } else {
    "Ihre Leistungsmotivation ist **moderat** – ein klarer Purpose & gute Rahmenbedingungen heben das Niveau."
  }

  paste0(
    "Sie zeigen ein Profil vom Typ **", gsub("_", " ", dom), "**: ", dom_text, ". ",
    uf_text, " ", lm_text
  )
}

# Top-3 Rollen
ord <- order(role_vals, decreasing = TRUE)
top3_names <- names(role_vals)[ord][1:3]
top3_vals  <- role_vals[ord][1:3]

# Farben
col_primary <- "#2563EB" # blau
col_secondary <- "#F59E0B" # orange

<style>
.kpi { display:flex; gap:24px; align-items:center; margin: 8px 0 24px 0; }
.kpi .card { flex:1; border:1px solid #e5e7eb; border-radius:12px; padding:16px 20px; background:#fafafa; }
.kpi .val { font-size: 28px; font-weight:700; color:#111827; }
.kpi .lbl { color:#6b7280; margin-top:4px; }
.header { display:flex; align-items:center; gap:18px; margin: 8px 0 8px 0;}
.header img { width:72px; height:72px; border-radius:50%; object-fit:cover; border:1px solid #e5e7eb;}
.caption { color:#6b7280; font-size: 14px; }
</style>


<div class="header">
  `r if (nzchar(params$photo_url)) sprintf('<img src="%s" alt="Foto"/>', params$photo_url) else ""`
  <div>
    <div class="caption">Kurzüberblick</div>
    <div><strong>Dominanter Rollentyp:</strong> `r gsub("_"," ", dom)`</div>
  </div>
</div>



par(mar = c(4, 5, 2, 1))
barplot(
  c(Unternehmerfähigkeit = uf, Leistungsmotivation = lm),
  ylim = c(0, 5),
  ylab = "Skalenwert (0–5)",
  main = "Kompetenzprofil",
  col = c(col_primary, col_secondary)
)
abline(h = 0:5, col = "#eeeeee", lty = 3)



spider_plot(role_vals, names(role_vals), maxv = 100,
            grid_steps = 5, title = "Ausprägung je Rollentyp (0–100)",
            col_fill = col_primary)



top_df <- data.frame(Rolle = top3_names, Auspraegung = top3_vals, check.names = FALSE)
knitr::kable(top_df, align = c('l','r'), col.names = c("Rolle", "Ausprägung"))


cat(describe_profile(dom, uf, lm))


---

### Was du *evtl.* noch anpassen musst

- Du nutzt bereits `plumber.R`, um `rmarkdown::render("onepager.Rmd", params = list(ergebnis = result$ergebnis), ...)` aufzurufen.  
  Wenn du ein Foto mitgeben willst, erweitere das um `photo_url`, z. B.:

  ```r
  rmarkdown::render(
    "onepager.Rmd",
    params = list(
      ergebnis  = result$ergebnis,
      photo_url = body$photo_url %||% ""
    ),
    output_file = tmp,
    quiet = TRUE
  )
